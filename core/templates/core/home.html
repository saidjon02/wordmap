{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <link href="https://cdn.boxicons.com/fonts/basic/boxicons.min.css" rel="stylesheet" />
    <title>Home</title>
  </head>
  <body>
    <div class="height">
      <div class="container">
        <div class="settings">
          {% if user.is_authenticated %}
          <a href="#" id="settings-icon"><i class="bx bx-cog"></i></a>
          <ul id="settings-dropdown">
            <li
              onclick="window.location.href='{% url 'change_password' %}'"
              style="cursor: pointer"
            >
              <a href="{% url 'change_password' %}">Change password</a>
            </li>
            <li
              onclick="window.location.href='{% url 'change_products' %}'"
              style="cursor: pointer"
            >
              <a href="{% url 'change_products' %}">Words</a>
            </li>
            <li onclick="window.location.href='{% url 'add_word' %}'" style="cursor: pointer">
              <a href="{% url 'add_word' %}">Add new word</a>
            </li>
            <li style="cursor: pointer">
              <form method="post" action="{% url 'logout' %}">
                {% csrf_token %}
                <button
                  type="submit"
                  class="red"
                  style="background: none; border: none; color: red; cursor: pointer"
                >
                  Logout
                </button>
              </form>
            </li>
          </ul>
          {% endif %}
        </div>

        <h2 class="search-word-title">Which added word do you want to search for?</h2>
        <form method="post" id="search-form">
          {% csrf_token %}
          <input
            type="search"
            class="search-input"
            name="query"
            id="search-input"
            placeholder="Search for added words"
            autocomplete="off"
            value="{{ query|default:'' }}"
          />

          <button type="submit"><i class="bx bx-search-big"></i></button>
          <ul id="suggestions-list"></ul>
        </form>

        {% if response %}
        <div class="natija" style="position: relative">
          <button
            onclick="copyToClipboard()"
            style="
              position: absolute;
              top: 20px;
              right: 20px;
              padding: 5px 10px;
              font-size: 12px;
              background-color: #4caf50;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
            "
          >
            Copy
          </button>
          <p><span id="output">{{ response|linebreaksbr|safe }}</span></p>
        </div>

        {% endif %}
      </div>
      <div class="successs">
        <div class="success">
          <p class="success-text">Copied Success!</p>
        </div>
      </div>
      {% if welcome_username %}
      <div id="welcome-overlay">
        <h2>Welcome {{ welcome_username }}</h2>
      </div>
      {% endif %}
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const overlay = document.getElementById('welcome-overlay');
        if (!overlay) return;

        // pastga tushirish
        overlay.classList.add('show');

        // 3 soniyadan keyin yuqoriga qaytarib yo‘q qilamiz
        setTimeout(() => {
          overlay.classList.remove('show');
          // animatsiya tugagach butunlay o‘chirib tashlash (ixtiyoriy)
          overlay.addEventListener('transitionend', () => overlay.remove());
        }, 3000);
      });
      function copyToClipboard() {
        const successText = document.querySelector('.successs');
        const html = document.getElementById('output').innerHTML;

        const cleanText = html.replace(/<br\s*\/?>/gi, '\n'); // <br> ni \n ga almashtiramiz

        navigator.clipboard
          .writeText(cleanText)
          .then(() => {
            successText.classList.add('success-show');
            setTimeout(() => {
              successText.classList.remove('success-show');
            }, 2000);
          })
          .catch((err) => {
            alert('Nusxa olishda xatolik yuz berdi: ' + err);
          });
      }

      document.addEventListener('DOMContentLoaded', () => {
        // ========== DROPDOWN ==========
        const icon = document.getElementById('settings-icon');
        const dropdown = document.getElementById('settings-dropdown');

        icon.addEventListener('click', (e) => {
          e.preventDefault();
          dropdown.classList.toggle('show');
        });

        document.addEventListener('click', (e) => {
          if (!icon.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.remove('show');
          }
        });

        // ========== SEARCH SUGGESTIONS & FORM SUBMIT ==========
        const input = document.getElementById('search-input');
        const suggestionBox = document.getElementById('suggestions-list');
        const form = document.getElementById('search-form');

        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            document.cookie.split(';').forEach((cookie) => {
              let [k, v] = cookie.trim().split('=');
              if (k === name) cookieValue = decodeURIComponent(v);
            });
          }
          return cookieValue;
        }

        input.addEventListener('input', function () {
          const term = this.value.trim();
          if (!term) return (suggestionBox.style.display = 'none');

          fetch(`/search_suggestions/?term=${encodeURIComponent(term)}`)
            .then((res) => res.json())
            .then((data) => {
              suggestionBox.innerHTML = '';
              if (data.length) {
                data.forEach((item) => {
                  let li = document.createElement('li');
                  li.textContent = item;
                  li.addEventListener('click', () => {
                    input.value = item;
                    suggestionBox.style.display = 'none';
                    // Formni submit qilamiz
                    form.submit();
                  });
                  suggestionBox.appendChild(li);
                });
                suggestionBox.style.display = 'block';
              }
            });
        });

        // klik tashqariga bosilganda suggestion ni yashirish
        document.addEventListener('click', (e) => {
          if (!form.contains(e.target)) {
            suggestionBox.style.display = 'none';
          }
        });
      });
    </script>
  </body>
</html>
